"""
dcf.py â€” Discounted Cash Flow Valuation

Purpose:
- Take Free Cash Flow projections generated by three_statement.py
- Apply a discount rate (WACC)
- Compute Present Value (PV) of each projected FCF
- Add Terminal Value (TV)
- Return enterprise value (EV), and optionally equity value/share price

This module is unit-testable without Excel and uses structured dataclass outputs.
"""

from typing import Dict, Any, List, Optional

from app.services.modeling.types import (
    ThreeStatementOutput,
    DcfOutput,
    DcfYearResult,
    Year,
)


def run_dcf(
    projections: ThreeStatementOutput,
    assumptions: Dict[str, Any],
) -> DcfOutput:
    """
    Main entrypoint for DCF valuation (MVP - no database).

    Args:
        projections: ThreeStatementOutput from run_three_statement()
        assumptions: Dict with keys:
            - wacc: float (weighted average cost of capital, e.g., 0.10 for 10%)
            - terminal_growth_rate: float (perpetual growth rate, e.g., 0.025 for 2.5%)
            - shares_outstanding: float | None (for share price calculation)
            - debt: float | None (for equity value calculation)
            - cash: float | None (for equity value calculation)

    Returns:
        DcfOutput with yearly results and valuation metrics
    """
    fcf_list = projections.free_cash_flow
    periods = projections.periods
    
    if not fcf_list:
        raise ValueError("No free cash flow projections provided")

    # Extract assumptions with defaults
    wacc = assumptions.get("wacc", 0.10)  # 10% default
    terminal_growth = assumptions.get("terminal_growth_rate", 0.025)  # 2.5% default
    shares_outstanding = assumptions.get("shares_outstanding")
    debt = assumptions.get("debt", 0.0)
    cash = assumptions.get("cash", 0.0)

    # Validate WACC and terminal growth
    if wacc <= 0:
        raise ValueError("WACC must be positive")
    if terminal_growth >= wacc:
        raise ValueError("Terminal growth rate must be less than WACC")

    # Step 1: Calculate present value of each projected FCF
    yearly_results: List[DcfYearResult] = []
    
    for i, fcf in enumerate(fcf_list):
        # Extract year from period string (YYYY-MM-DD format)
        period_str = periods[i] if i < len(periods) else f"Year{i+1}"
        try:
            year = int(period_str.split("-")[0])
        except (ValueError, IndexError):
            # Fallback: use sequential year numbering
            year = 2024 + i + 1
        
        # Discount factor: 1 / (1 + WACC)^(period_number)
        # Period 1 is discounted by 1 year, period 2 by 2 years, etc.
        discount_factor = 1.0 / ((1 + wacc) ** (i + 1))
        
        pv_ufcf = fcf * discount_factor
        
        yearly_results.append(DcfYearResult(
            year=year,
            ufcf=fcf,
            discount_factor=discount_factor,
            pv_ufcf=pv_ufcf
        ))

    # Step 2: Calculate Terminal Value
    # Using Gordon Growth Model: TV = FCF[last] * (1 + g) / (WACC - g)
    last_fcf = fcf_list[-1]
    terminal_value = last_fcf * (1 + terminal_growth) / (wacc - terminal_growth)

    # Step 3: Discount Terminal Value to present
    # TV is at end of projection period, so discount by number of periods
    num_periods = len(fcf_list)
    pv_terminal_value = terminal_value / ((1 + wacc) ** num_periods)

    # Step 4: Calculate Enterprise Value
    # EV = Sum of PV(UFCF) + PV(Terminal Value)
    pv_fcf_sum = sum(result.pv_ufcf for result in yearly_results)
    enterprise_value = pv_fcf_sum + pv_terminal_value

    # Step 5: Calculate Equity Value (if balance sheet data available)
    equity_value: Optional[float] = None
    implied_share_price: Optional[float] = None
    
    if shares_outstanding is not None:
        # Equity Value = Enterprise Value - Debt + Cash
        equity_value = enterprise_value - debt + cash
        
        # Implied share price
        if shares_outstanding > 0:
            implied_share_price = equity_value / shares_outstanding

    return DcfOutput(
        yearly_results=yearly_results,
        terminal_value=terminal_value,
        pv_terminal_value=pv_terminal_value,
        enterprise_value=enterprise_value,
        equity_value=equity_value,
        implied_share_price=implied_share_price,
        wacc=wacc,
        terminal_growth_rate=terminal_growth,
    )
